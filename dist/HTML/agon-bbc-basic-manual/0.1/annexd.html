<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: BBC BASIC (Z80) for the Agon Light</title>
    <link rel="canonical" href="https://oldpatientsea.github.io/agon-bbc-basic-manual/0.1/annexd.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://oldpatientsea.github.io">BBC BASIC (Z80) for the Agon Light</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="agon-bbc-basic-manual" data-version="0.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">BBC BASIC (Z80) for the Agon Light</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bbc1.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bbc2.html">General Information</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bbc3.html">Assembler</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bbckey0.html">Statements and Functions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bbckey1.html">ABS-ENVELOPE</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bbckey2.html">EOF#-LOMEM</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bbckey3.html">MID$-PRINT</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bbckey4.html">PRINT#-WIDTH</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="opsys0.html">Operating System Interface</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="opsys1.html">Resident Star Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bbcfile1.html">BBC BASIC (Z80) Disk Files</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bbcfile2.html">Serial Files</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bbcfile3.html">Random (Relative) Files</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bbcfile4.html">Indexed Data Files</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="annexa.html">Table of ASCII Codes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="annexb.html">Mathematical Functions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="annexc.html">Error Messages and Codes</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="annexd.html">Format of Program and Variables in Memory</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="copyright.html">Copyrights</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">BBC BASIC (Z80) for the Agon Light</span>
    <span class="version">0.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">BBC BASIC (Z80) for the Agon Light</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="bbc1.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">BBC BASIC (Z80) for the Agon Light</a></li>
    <li><a href="annexd.html">Format of Program and Variables in Memory</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/oldpatientsea/agon-bbc-basic-manual/edit/main/modules/ROOT/pages/annexd.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="sect2">
<h3 id="_annex_d_to_bbc_basic_z80"><a class="anchor" href="#_annex_d_to_bbc_basic_z80"></a>Annex D to BBC BASIC (Z80)</h3>

</div>
<div class="sect2">
<h3 id="_memory_map"><a class="anchor" href="#_memory_map"></a><span id="memorymap">Memory Map</span></h3>
<div class="paragraph">
<p>BBC BASIC (Z80) runs under the CP/M-80 operating system. It requires about 15 Kbytes of code space. The interpreter&#8217;s internal variables occupy approximately 1 Kbyte of memory</p>
</div>
<div class="paragraph">
<p>By default, your program will start on the page boundary immediately following the interpreter&#8217;s data area and the 'dynamic data structures' will immediately follow your program. The total group of the dynamic data structures is called the 'heap'. The base of the program control stack is located at <a href="bbckey2.html#himem">HIMEM</a>.</p>
</div>
<div class="paragraph">
<p>As your program runs, the heap expands upwards towards the stack and the stack expands downwards towards the heap. If the two should meet, you get a '<a href="annexc.html#noroom">No room</a>' error. Fortunately, there is a limit to the amount by which the stack and the heap expand.</p>
</div>
<div class="paragraph">
<p>In general, the heap only expands whilst new variables are being declared. However, bad management of string variables can also cause the heap to expand.</p>
</div>
<div class="paragraph">
<p>In addition to running your program, the stack is also used 'internally' by the BBC BASIC (Z80) interpreter. Its size fluctuates but, in general, it expands every time you increase the depth of nesting of your program structure and every time you increase the number of local variables in use.</p>
</div>
<div class="sect3">
<h4 id="_the_memory_map"><a class="anchor" href="#_the_memory_map"></a><span id="memorymap">The Memory Map</span></h4>
<table class="tableblock frame-all grid-all stretch">
</table>
<div class="paragraph">
<p>|HIMEM
|LOMEM/TOP
|PAGE</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>|</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">[width="100%",cols="^100%",]</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>|Stack<br>
↓
|(unused)
|↑<br>
Heap
|User&#8217;s Program
|Interpreter and workspace</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>|Top of Transient Program Area
|Current limit of stack
|Current limit of heap
|Heap base/end of program
|Start of program
|&amp;100</p>
</div>
<table class="tableblock frame-all grid-all stretch">
</table>
<div class="paragraph">
<p>The function of <a href="bbckey2.html#himem">HIMEM</a>, <a href="bbckey2.html#lomem">LOMEM</a>, <a href="bbckey4.html#top">TOP</a> and <a href="bbckey3.html#page">PAGE</a> are briefly discussed below. You will find more complete definitions elsewhere in this manual. You can directly set HIMEM, LOMEM and PAGE. However, for most of your programs you won&#8217;t need to alter any of them. You will probably only need to change HIMEM if you want to put some machine code sub-routines at the top of memory.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="bbckey2.html#himem">HIMEM</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The first address at the top of memory which is not available for use by BBC BASIC (Z80). The base of the program stack is set at HIMEM. (The first 'thing' stored on the stack goes at HIMEM-1.)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="bbckey2.html#lomem">LOMEM</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The start address for the heap. The first of the dynamic data structures starts at LOMEM.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="bbckey4.html#top">TOP</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The first free location after the end of your program. Unless you have set LOMEM yourself, LOMEM=TOP. You cannot directly set TOP. It alters as you enter your program. The current length of your program is given by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">PRINT TOP-PAGE</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="bbckey3.html#page">PAGE</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The address of the start of your program. You can place several programs in memory and switch between them by using PAGE. Don&#8217;t forget to control LOMEM as well. If you don&#8217;t, the heap for one program might overwrite another program.</p></td>
</tr>
</tbody>
</table>
<hr>
</div>
</div>
<div class="sect2">
<h3 id="_memory_management"><a class="anchor" href="#_memory_management"></a><span id="management">Memory Management</span></h3>
<div class="paragraph">
<p>There is little you can do to control the growth of the stack. However, with care, you can control the growth of the heap. You can do this by limiting the number of variables you use and by good string variable management.</p>
</div>
<div class="sect3">
<h4 id="_limiting_the_number_of_variables"><a class="anchor" href="#_limiting_the_number_of_variables"></a><span id="limiting">Limiting the Number of Variables</span></h4>
<div class="paragraph">
<p>Each new variable occupies room on the heap. Restricting the length of the names of variables and limiting the number of variables used will limit the size of the heap. However, of the techniques available to you, this is the least rewarding. In addition, it leads to incomprehensible programs because your variable names become meaningless. You should keep this technique in the back of your mind whilst you are programming, but only apply it rigorously if you are really stuck for space.</p>
</div>
</div>
<div class="sect3">
<h4 id="_string_management"><a class="anchor" href="#_string_management"></a><span id="stringmanage">String Management</span></h4>
<div class="sect4">
<h5 id="_garbage_generation"><a class="anchor" href="#_garbage_generation"></a><span id="garbage">Garbage Generation</span></h5>
<div class="paragraph">
<p>Unlike numeric variables, string variables do not have a fixed length. When you create a string variable it is added to the heap and sufficient memory is allocated for the initial value of the string. If you subsequently assign a longer string to the variable there will be insufficient room for it in its original position and the string will have to be relocated with its new value at the top of the heap. The initial area will then become 'dead' and the heap will have grown by the new length of the string. The areas of 'dead' memory are called garbage. As more and more re-assignments take place, the heap grows and eventually there is no more room. Thus, it is possible to run out of room for variables even though there should be enough space.</p>
</div>
</div>
<div class="sect4">
<h5 id="_memory_allocation_for_string_variables"><a class="anchor" href="#_memory_allocation_for_string_variables"></a><span id="stringallocation">Memory Allocation for String Variables</span></h5>
<div class="paragraph">
<p>You can overcome the problem of 'garbage' by reserving enough memory for the longest string you will ever put into a variable before you use it. You do this simply by assigning a string of spaces to the variable. If your program needs to find an empty string the first time it is used, you can subsequently assign a null string to it. The same technique can be used for string arrays. The example below sets up a single dimensional string array with room for 20 characters in each entry, and then empties it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">10 DIM names$(10)
20 FOR i=0 TO 10
30   name$(i)=STRING$(20," ")
40 NEXT
50 stop$=""
60 FOR i=0 TO 10
70   name$(i)=""
80 NEXT</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assigning a null string to stop$ prevents the space for the last entry in the array being recovered when it is emptied.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_program_storage_in_memory"><a class="anchor" href="#_program_storage_in_memory"></a><span id="programstorage">Program Storage in Memory</span></h3>
<div class="paragraph">
<p>The program is stored in memory in the format shown below. The first program line commences at <a href="bbckey3.html#page">PAGE</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3337%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">LSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">token</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>:</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">token</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&amp;0D</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>Reserved Word Tokens</p>
</div>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>CR</p>
</div>
<div class="paragraph">
<p>Line No</p>
</div>
<div class="paragraph">
<p>←</p>
</div>
<div class="paragraph">
<p>Program Line</p>
</div>
<div class="paragraph">
<p>→</p>
</div>
<div class="sect3">
<h4 id="_line_length"><a class="anchor" href="#_line_length"></a><span id="linelength">Line Length</span></h4>
<div class="paragraph">
<p>The line length includes the line length byte. The address of the start of the next line is found by adding the line length to the address of the start of the current line. The end of the program is indicated by a line length of zero and a line number of &amp;FFFF.</p>
</div>
</div>
<div class="sect3">
<h4 id="_line_number"><a class="anchor" href="#_line_number"></a><span id="linenumber">Line Number</span></h4>
<div class="paragraph">
<p>The line number is stored in two bytes, LSB first. The end of the program is indicated by a line number of &amp;FFFF and a line length of zero.</p>
</div>
</div>
<div class="sect3">
<h4 id="_statements"><a class="anchor" href="#_statements"></a><span id="statements">Statements</span></h4>
<div class="paragraph">
<p>With the exception of the symbols '*', '=' and '[' and the optional reserved word <a href="bbckey2.html#let">LET</a>, each statement in the line commences with the appropriate reserved word token. Reserved words are tokenised wherever they occur. A token is indicated by bit 7 of the byte being set. Statements within a line are separated by colons.</p>
</div>
</div>
<div class="sect3">
<h4 id="_line_terminator"><a class="anchor" href="#_line_terminator"></a><span id="terminator">Line Terminator</span></h4>
<div class="paragraph">
<p>Each program line (except the last) is terminated by a carriage-return (&amp;0D).</p>
</div>
<hr>
</div>
</div>
<div class="sect2">
<h3 id="_variable_storage_in_memory"><a class="anchor" href="#_variable_storage_in_memory"></a><span id="variablestorage">Variable Storage in Memory</span></h3>
<div class="paragraph">
<p>Variables are held within memory as linked lists (chains). The first variable in each chain is accessed via an index which is maintained by BBC BASIC (Z80). There is an entry in the index for each of the characters permitted as the first letter of a variable name. Each entry in the index has a word (two bytes) address field which points to the first variable in the linked list with a name starting with its associated character. If there are no variables with this character as the first character in the name, the pointer word is zero. The first word of all variables holds the address of the next variable in the chain. The address word of the last variable in the chain is zero. All addresses are held in the standard Z80 format - LSB first.</p>
</div>
<div class="paragraph">
<p>The first variable created for each starting character is accessed via the index and subsequently created variables are accessed via the index and the chain. Consequently, there is some speed advantage to be gained by arranging for all your variables to start with a different character. Unfortunately, this can lead to some pretty unreadable names and programs.</p>
</div>
<div class="sect3">
<h4 id="_integer_variables"><a class="anchor" href="#_integer_variables"></a><span id="integer">Integer Variables</span></h4>
<div class="paragraph">
<p>Integers are held in two&#8217;s complement format. They occupy 4 bytes, with the LSB first. Bit 7 of the MSB is the sign bit. To make up the complete variable, the address word, the name and a separator (zero) byte are added to the number. The format of the memory occupied by an integer variable called 'NUMBER%' is shown below. Note that since the first character of the name is found via the index, it is not stored with the variable.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6924%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">LSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">U</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">M</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">B</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">E</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">R</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">%</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&amp;00</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">LSB</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MSB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>←</p>
</div>
<div class="paragraph">
<p>Rest of Name</p>
</div>
<div class="paragraph">
<p>→</p>
</div>
<div class="paragraph">
<p>←</p>
</div>
<div class="paragraph">
<p>Value</p>
</div>
<div class="paragraph">
<p>→</p>
</div>
<div class="paragraph">
<p>Address of next variable</p>
</div>
<div class="paragraph">
<p>starting with the same letter</p>
</div>
<div class="paragraph">
<p>The smallest amount of space is taken up by a variable with a single letter name. The static integer variables, which are not included in the variable chains, use the names A% to Z%. Thus, the only single character names available for dynamic integer variables are a% to z% plus _% and <strong>`</strong>% (CHR$(96)). As shown below, integer variables with these names will occupy 8 bytes.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">LSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">%</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&amp;00</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">LSB</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MSB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>←</p>
</div>
<div class="paragraph">
<p>Value</p>
</div>
<div class="paragraph">
<p>→</p>
</div>
<div class="paragraph">
<p>Address of next variable</p>
</div>
<div class="paragraph">
<p>starting with the same letter</p>
</div>
</div>
<div class="sect3">
<h4 id="_real_variables"><a class="anchor" href="#_real_variables"></a><span id="real">Real Variables</span></h4>
<div class="paragraph">
<p>Real numbers are held in binary floating point format. The mantissa is held as a 4 byte binary fraction in sign and magnitude format. Bit 7 of the MSB of the mantissa is the sign bit. When working out the value of the mantissa, this bit is assumed to be 1 (a decimal value of 0.5). The exponent is held as a single byte in 'excess 127' format. In other words, if the actual exponent is zero, the value of stored in the exponent byte is 127. To make up the complete variable, the address word, the name and a separator (zero) byte are added to the number. The format of the memory occupied by a real variable called 'NUMBER' is shown below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6924%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">LSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">U</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">M</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">B</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">E</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">R</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&amp;00</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">LSB</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">EXP</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>←</p>
</div>
<div class="paragraph">
<p>Rest of Name</p>
</div>
<div class="paragraph">
<p>→</p>
</div>
<div class="paragraph">
<p>←</p>
</div>
<div class="paragraph">
<p>Mantissa</p>
</div>
<div class="paragraph">
<p>→</p>
</div>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>Address of next variable</p>
</div>
<div class="paragraph">
<p>Exponent</p>
</div>
<div class="paragraph">
<p>starting with the same letter</p>
</div>
<div class="paragraph">
<p>As with integer variables, variables with single character names occupy the least memory. (However, the names A to Z are available for dynamic real variables.) Whilst a real variable requires an extra byte to store the number, the '%' character is not needed in the name. Thus, integer and real variables with the same name occupy the same amount of memory. However, this does not hold for arrays, since the name is only stored once.</p>
</div>
<div class="paragraph">
<p>In the following examples, the bytes are shown in the more human-readable manner with the MSB on the left.</p>
</div>
<div class="paragraph">
<p>The value 5.5 would be stored as shown below.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Mantissa</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>`  <code>Exponent</code>  `</p>
</div>
<div class="paragraph">
<div class="title">0011 0000</div>
<p>0000 0000</p>
</div>
<div class="paragraph">
<p>0000 0000</p>
</div>
<div class="paragraph">
<p>0000 0000</p>
</div>
<div class="paragraph">
<p>1000 0010</p>
</div>
<div class="paragraph">
<p>↑Sign Bit</p>
</div>
<div class="paragraph">
<p>&amp;30</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>&amp;82</p>
</div>
<div class="paragraph">
<p>Because the sign bit is assumed to be 1, this would become:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Mantissa</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>`  <code>Exponent</code>  `</p>
</div>
<div class="paragraph">
<div class="title">1011 0000</div>
<p>0000 0000</p>
</div>
<div class="paragraph">
<p>0000 0000</p>
</div>
<div class="paragraph">
<p>0000 0000</p>
</div>
<div class="paragraph">
<p>1000 0010</p>
</div>
<div class="paragraph">
<p>&amp;B0</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>&amp;82</p>
</div>
<div class="paragraph">
<p>The equivalent in decimal is:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>     (0.5+0.125+0.0625) * 2^(130-127)<br>
=   0.6875 * 2^3<br>
=   0.6875 * 8<br>
=   5.5</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>BBC BASIC (Z80) stores integer values in real variables in a special way which allows the faster integer arithmetic routines to be used if appropriate. The presence of an integer value in a real variable is indicated by the stored exponent being zero. Thus, if the stored exponent is zero, the real variable is being used to hold an integer and the 4 byte mantissa holds the number in normal integer format.</p>
</div>
<div class="paragraph">
<p>Depending on how it is put there, an integer value can be stored in a real variable in one of two ways. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">number=5</code></pre>
</div>
</div>
<div class="paragraph">
<p>will set the exponent to zero and store the integer &amp;00 00 00 05 in the mantissa. On the other hand,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">number=5.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>will set the exponent to &amp;82 and the mantissa to &amp;20 00 00 00.</p>
</div>
<div class="paragraph">
<p>The two ways of storing an integer value are illustrated in the following four examples.</p>
</div>
<div class="paragraph">
<p><strong>Example 1</strong></p>
</div>
<div class="paragraph">
<p>`  number=5      `</p>
</div>
<div class="paragraph">
<p>&amp; 00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>05</p>
</div>
<div class="paragraph">
<p>Integer 5</p>
</div>
<div class="paragraph">
<p><strong>Example 2</strong></p>
</div>
<div class="paragraph">
<p>`  number=5.0`</p>
</div>
<div class="paragraph">
<p>&amp; 82</p>
</div>
<div class="paragraph">
<p>20</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>Real 5.0</p>
</div>
<div class="paragraph">
<p>This is treated as</p>
</div>
<div class="paragraph">
<p>&amp; 82</p>
</div>
<div class="paragraph">
<p>A0</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
</div>
</div>
<h1 id="" class="sect0"><a class="anchor" href="#"></a>+</h1>

<h1 id="_2" class="sect0"><a class="anchor" href="#_2"></a>+</h1>
<div class="paragraph">
<p>=</p>
</div>
<div class="paragraph">
<p>(0.5+0.125)*2^(130-127)<br>
0.625*8<br>
5</p>
</div>
<div class="paragraph">
<p>because the sign bit is assumed to be 1.</p>
</div>
<div class="paragraph">
<p><strong>Example 3</strong></p>
</div>
<div class="paragraph">
<p>`  number=-5`</p>
</div>
<div class="paragraph">
<p>&amp; 00</p>
</div>
<div class="paragraph">
<p>FF</p>
</div>
<div class="paragraph">
<p>FF</p>
</div>
<div class="paragraph">
<p>FF</p>
</div>
<div class="paragraph">
<p>FB</p>
</div>
<div class="paragraph">
<p>The 2&#8217;s complement gives</p>
</div>
<div class="paragraph">
<p>&amp; 00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>05</p>
</div>
<div class="paragraph">
<p>Integer -5</p>
</div>
<div class="paragraph">
<p><strong>Example 4</strong></p>
</div>
<div class="paragraph">
<p>`  number=-5.0`</p>
</div>
<div class="paragraph">
<p>&amp; 82</p>
</div>
<div class="paragraph">
<p>A0</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>00</p>
</div>
<div class="paragraph">
<p>Real -5.0</p>
</div>
<div class="paragraph">
<p>(The sign bit is already 1)</p>
</div>
<h1 id="_3" class="sect0"><a class="anchor" href="#_3"></a>+</h1>

<h1 id="_4" class="sect0"><a class="anchor" href="#_4"></a>+</h1>
<div class="paragraph">
<p>Magnitude =</p>
</div>
<div class="paragraph">
<p>(0.5+0.125)*2^(130-127)<br>
0.625*8<br>
5<br></p>
</div>
<div class="paragraph">
<p>If all this seems a little complicated, try using the program on the next page to accept a number from the keyboard and display the way it is stored in memory. The program displays the 4 bytes of the mantissa in 'human readable order' followed by the exponent byte. Look at what happens when you input first 5 and then 5.0 and you will see how this corresponds to the explanation given above. Then try -5 and -5.0 and then some other numbers. (The program is an example of the use of the byte indirection operator. See the <a href="bbc2.html#indirection">Indirection</a> section for details.)</p>
</div>
<div class="paragraph">
<p>The layout of the variable 'NMBR' in memory is shown below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3337%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">LSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">M</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">B</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">R</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&amp;00</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">LSB</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">EXP</p></td>
<td class="tableblock halign-center valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>A%-5 points here</p>
</div>
<div class="paragraph">
<p>A%-2 points here</p>
</div>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>A%-1 points here</p>
</div>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>A% points here</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console"> 10 NUMBER=0
 20 DIM A% -1
 30 REPEAT
 40   INPUT"NUMBER PLEASE "NUMBER
 50   PRINT "&amp; ";
 60   :
 70   REM Step through mantissa from MSB to LSB
 80   FOR I%=2 TO 5
 90     REM Look at value at address A%-I%
100     NUM$=STR$~(A%?-I%)
110     IF LEN(NUM$)=1 NUM$="0"+NUM$
120     PRINT NUM$;" ";
130   NEXT
140   :
150   REM Look at exponent at address A%-1
160   N%=A%?-1
170   NUM$=STR$~(N%)
180   IF LEN(NUM$)=1 NUM$="0"+NUM$
190   PRINT " &amp; "+NUM$''
200 UNTIL NUMBER=0</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_string_variables"><a class="anchor" href="#_string_variables"></a><span id="string">String Variables</span></h4>
<div class="paragraph">
<p>String variables are stored as the string of characters. Since the current length of the string is stored in memory an explicit terminator for the string in unnecessary. As with numeric variables, the first word of the complete variable is the address of the next variable starting with the same character. However, since BBC BASIC (Z80) needs information about the length of the string and the address in memory where the it starts, the overheads for a string are more than for a numeric. The format of a string variable called 'NAME$' is shown below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.091%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">LSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">M</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">E</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">$</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&amp;00</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">len</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">max</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">LSB</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MSB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>←</p>
</div>
<div class="paragraph">
<p>Rest of name</p>
</div>
<div class="paragraph">
<p>→</p>
</div>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>↑</p>
</div>
<div class="paragraph">
<p>Address of next variable</p>
</div>
<div class="paragraph">
<p>Current string length</p>
</div>
<div class="paragraph">
<p>String start address</p>
</div>
<div class="paragraph">
<p>starting with the same letter</p>
</div>
<div class="paragraph">
<p>Max (original) length ↑`  `</p>
</div>
<div class="paragraph">
<p>When a string variable is first created in memory, the characters of the string follow immediately after the two bytes containing the start address of the string and the current and maximum lengths are the same. While the current length of the string does not exceed its length when created, the characters of the string will follow the address bytes. When the string variable is set to a string which is longer than its original length, there will be insufficient room in the original position for the characters of the string. When this happens, the string will be placed on the top of the heap and the new start address will be loaded into the two address bytes. The original string space will remain, but it will be unusable. This unusable string space is called 'garbage'. See the <a href="bbc2.html#variables">Variables</a> sub-section for ways to avoid creating <a href="bbc2.html#garbage">garbage</a>.</p>
</div>
<div class="paragraph">
<p>Because the original length and the current length of the string are each stored in a single byte in memory, the maximum length of a string held in a string variable is 255 characters.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fixed_strings"><a class="anchor" href="#_fixed_strings"></a><span id="fixedstrings">Fixed Strings</span></h4>
<div class="paragraph">
<p>You can place a string starting at a given location in memory using the indirection operator '$'. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$&amp;8000="This is a string"</code></pre>
</div>
</div>
<div class="paragraph">
<p>would place &amp;54 (T) at address &amp;8000, &amp;68 (h) at address &amp;8001, etc. Because the string is placed at a predetermined location in memory it is called a 'fixed' string. Fixed strings are not included in the variable chains and they do not have the overheads associated with a string variable. However, since the length of the string is not stored, an explicit terminator (&amp;0D) is used. Consequently, in the above example, byte &amp;8010 would be set to &amp;0D.</p>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
